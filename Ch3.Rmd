---
output:
  html_document: default
  word_document: default
fontsize: 12pt
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<style>
.column-left{
float: left;
width: 18%;
text-align: left;
}
.column-center{
display: inline-block;
width: 74%;
text-align: center;
}
.column-right{
float: right;
width: 28%;
text-align: right;
}
</style>

<div class="column-left">

</div>
<div class = "column-center">
<span style="color: grey">**Chapter 3: Genetic concepts and tools to support wildlife
population ecology **</span>
<style type="text/css">
body{
font-size: 14pt;
}
</style>

</div>
<div class = "column-right">
```{r, out.width = "200px", echo=FALSE}
knitr::include_graphics("C:/Users/mahdi/Desktop/CWPBook/Figs/CoverImage_Ed2.jpeg")
```
</div>

---


<br>

## Overview
Abundance is probably the piece of information most sought after in wildlife population ecology: it is essential for determining hunting regulations, for deciding on protection for species and for evaluating the effects of predation or human actions, to name just a few. It is almost impossible that a direct count of encountered individuals equals to the actual size of the population because of reasons mentioned in Chapter 4. Genetic tools have truely awesome potential to estimate abundance using appropriate statistical framework.

## Data
Many populations of Pacific salmon (Oncorhynchus spp.) from southern California to northern Washington are listed for protection under the US Endangered Species Act 1973 (ESA). Here we use a [published](https://onlinelibrary.wiley.com/doi/10.1111/eva.13647) dataset on Chilkat River Chinook salmon (O. tshawytscha) in Southeast Alaska to estimate abundance using close-kin mark-recapture and parentage analysis.

This data set includes genetic data on sampled offspring and their assigned parent. First, let's explore the data. From 682 offspring, 220 were assigned to at least one parent. There are 147 unique parent IDs. 

```{r, results = "hide", out.width = "600px", fig.align = "center", message = FALSE, warning = FALSE}

salmon <- read.csv("https://raw.githubusercontent.com/swrosenbaum/tGMR_simulations/main/Data/ParentPair.csv")

nrow(salmon)
length(unique(salmon$OffspringID))

# Remove duplicates
salmon <- salmon[!duplicated(salmon$OffspringID),]

# How many unique parent ID
unique(salmon$InferredMum)
unique(salmon$InferredDad)

# How many offspring were assigned parent
assigned_p <- salmon[which(salmon$InferredDad != "*"),]
assigned_m <- salmon[which(salmon$InferredMum != "#"),]

assigned <- salmon[which(salmon$InferredDad != "*" |
                           salmon$InferredMum != "#"), ]

```

## Capture-recapture analysis
Now, let's quantify key population abundance statistics. In its simplest form, the 
estimator (Lincolnâ€“Petersen estimator with two sampling intervals; Chapter 4) will
use the observed marks (n1): the number of successfully genotyped adult samples in the
first sampling interval, the recaptures (m2): the number of genotyped adult samples that
were assigned as parents of genotyped offspring from the second sampling interval, and
the captures (n2): the number of genotypes obtained from juveniles sampled in the second
interval. 

Note that the number of sampled offspring is multiplied by 2, because offsprings carry genotypes of female and male parent and therefore have two opportunities to recapture marks. 

```{r, results = "hide", out.width = "600px", fig.align = "center", message = FALSE, warning = FALSE}

capture   <- n2 <- 682 * 2                        # number of offsprings
mark      <- n1 <- 583                            # number of adults
recapture <- m2 <- 147                            # number of adults assigned to an offspring

N         <- round((n1 * (n2 + 1)) / (m2 + 1), 0) # adult abundance

```

Let's plot these quantities. We can use barplot() to make a side-by-side comparison.

```{r, results = "hide", out.width = "600px", fig.align = "center", message = FALSE, warning = FALSE}

bar_data <- matrix(c(N, capture, mark, recapture), nrow = 4)
colnames(bar_data) <- "Number of individuals"
rownames(bar_data) <- c("Abundance", "captured", "marked", "recaptured")
 
barplot( height   = bar_data,
         names    = "",
         legend   = rownames(bar_data),
         ylab     = colnames(bar_data),
         xlab     = NA,
         las      = 2,
         lwd      = 2,
         beside   = T,
         density  = c(10, 5, 20, 30, 7),
         angle    = c(45, 0, 90, 11, 36),
         col      = "brown")

```

We calculated adult abundance based on observed values at 5377. But remember from Chapter 2, we need to produce generalisable results. If we repeat the sampling, each time we get a different estimate of the population size. For the Lincoln-Peterson estimator, the variation in estimates can be calculated as below.

```{r, results = "hide", out.width = "600px", fig.align = "center", message = FALSE, warning = FALSE}

var       <- (n1 ^ 2 * (n2 + 1) * (n2 - m2)) / ((m2 + 1) ^ 2 * (m2 + 2)) # variance; equation 4.9

```

Sampling variance is a common statistic to show parameter uncertainty. How about the 95% confidence intervals of the population size estimate? Well, we can calculate that using the standard deviation
of the sampling variance, i.e, the standard error.

```{r, results = "hide", out.width = "600px", fig.align = "center", message = FALSE, warning = FALSE}

uci <- N + (1.96 * (sqrt(var)))  # equation 4.10, in chapter 4
lci <- N - (1.96 * (sqrt(var)))

round(c(lci, uci), 0)

```
Based on this analysis, the Chinook salmon abundance is between 4562 and 6192, with a mean estimate of 5377 individuals. 


<div style = "background-color:beige;">
**Practice:** 

Generate new data using the probability distribution for m2, number of recaptures.
How does the estimate of N change with different numbers of recaptures?

```{r, out.width = "600px", fig.align = "center", message = FALSE, warning = FALSE}
N  <- 5300   # Set the true population size
p  <- 0.11   # Proportion of population marked
n2 <- N * p  # Number caught and examined for marks in second interval
m2 <- rbinom(1000, n2, p) # Number of marked fish in second interval
m2 <- m2[order(m2)]

Nhat <- round((n1 * (n2 + 1)) / (m2 + 1), 0) # adult abundance

plot(m2,
     Nhat,
     lwd  = 2,
     xlab = "Number of recaptures",
     ylab = "Adult abundance"
     )


```
 
</div>
